#!/usr/local/bin/node

var program = require('commander'),
    bodule = require('../').bodule,
    fs = require('fs'),
    watch = require('watch'),
    path = require('path')

program
  .option('-t, --type [type]', 'special wrapper type, cmd or amd')
  .option('-o, --output [path]', 'path to put wrapped files')
  .option('-w, --watch', 'watch file change, auto bodule')
  .parse(process.argv)

var src = program.args[0] || '.',
    dest = program.output || '.bodule',
    type = program.type || 'amd'

function walk(dir, done) {
    var results = []
    fs.readdir(dir, function(err, list) {
        if (err) return done(err)
        var pending = list.length
        if (!pending) return done(null, results)
        list.forEach(function(file) {
            file = dir + '/' + file
            fs.stat(file, function(err, stat) {
                if (stat && stat.isDirectory()) {
                    walk(file, function(err, res) {
                        results = results.concat(res)
                        if (!--pending) done(null, results)
                    })
                } else {
                    results.push(file)
                    if (!--pending) done(null, results)
                }
            })
        })
    })
}
// Comile file in `filePath` to `dest`

function wrapFile(filePath, type, dest) {
    var file, fileName
    fileName = path.basename(filePath)
    file = fs.readFileSync(filePath, 'utf8')
    file = bodule(file, {
        type: type
    })
    fs.writeFileSync(dest + '/' +  fileName, file)
    console.log(filePath + ' is wraped to ' + dest)
}

function wrapDir(dirPath, type, dest) {
    walk(dirPath, function(err, files){
        files =files.filter(function (file) {
            return file.indexOf('.bodule') == -1 && file.indexOf('.js') > -1
        })
        files.forEach(function (file) {
            wrapFile(path.normalize(src + '/' + file), type, dest)
        }) 
    })
}

if (!fs.existsSync(dest)) {
    fs.mkdirSync(dest)
}

if (program.watch) {
    if (fs.statSync(src).isDirectory()) {
        console.log(src + ' is watched!')
        watch.createMonitor(src, function (monitor) {
            monitor.on("created", function (f, stat) {
                wrapFile(f, type, dest)
            })
            monitor.on("changed", function (f, curr, prev) {
                wrapFile(f, type, dest)
            })
        })
    }
}


var files = []
if (src.indexOf('.js') > -1) {
    wrapFile(src, type, dest)
} else {
    wrapDir(src, type, dest)
} 
